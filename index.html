<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>Interrail 2014</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="main-style.css" />
    <link rel="stylesheet" href="popup-style.css" />
  </head>

  <body>

    <div id='map'></div>

    <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
    <script type="text/javascript" src="geo.js"></script>
    <script type="text/javascript" src="access-token.js"></script>

    <script>
        L.mapbox.accessToken = token;
        var map = L.mapbox.map('map', 'manutero.jjgomcin');

        // Add custom popup html to each marker.
        var myLayer = L.mapbox.featureLayer().addTo(map);
        myLayer.on('layeradd', function(e) {
            var marker = e.layer;
            var feature = marker.feature;
            var images = feature.properties.images
            var slideshowContent = '';

            for(var i = 0; i < images.length; i++) {
                var img = images[i];

                slideshowContent += '<div class="image' + (i === 0 ? ' active' : '') + '">' +
                                      '<img src="' + img[0] + '" />' +
                                      '<div class="caption">' + img[1] + '</div>' +
                                    '</div>';
            }

            // Create custom popup content
            var popupContent =  '<div id="' + feature.properties.id + '" class="popup">' +
                                    '<h2>' + feature.properties.title + '</h2>' +
                                    '<div class="slideshow">' +
                                        slideshowContent +
                                    '</div>' +
                                    '<div class="cycle">' +
                                        '<a href="#" class="prev">&laquo; Previous</a>' +
                                        '<a href="#" class="next">Next &raquo;</a>' +
                                    '</div>'
                                '</div>';

            // http://leafletjs.com/reference.html#popup
            marker.bindPopup(popupContent,{
                closeButton: false,
                minWidth: 320
            });
        });

        // Add features to the map
        myLayer.setGeoJSON(geoJson);

        $('#map').on('click', '.popup .cycle a', function() {
            var $slideshow = $('.slideshow'),
                $newSlide;

            if ($(this).hasClass('prev')) {
                $newSlide = $slideshow.find('.active').prev();
                if ($newSlide.index() < 0) {
                    $newSlide = $('.image').last();
                }
            } else {
                $newSlide = $slideshow.find('.active').next();
                if ($newSlide.index() < 0) {
                    $newSlide = $('.image').first();
                }
            }

            $slideshow.find('.active').removeClass('active').hide();
            $newSlide.addClass('active').show();
            return false;
        });

        // center on marker
        // FIXME NOT WORKING
        map.featureLayer.on('click', function(e) {
          map.panTo(e.layer.getLatLng());
        });

    </script>


</body>
</html>

